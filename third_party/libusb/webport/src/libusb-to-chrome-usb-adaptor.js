/**
 * @license
 * Copyright 2021 Google Inc.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
 */

goog.provide('GoogleSmartCard.LibusbToChromeUsbAdaptor');

goog.require('GoogleSmartCard.LibusbProxyDataModel');
goog.require('GoogleSmartCard.LibusbToJsApiAdaptor');
goog.require('goog.object');

goog.scope(function() {

const GSC = GoogleSmartCard;
const LibusbJsDevice = GSC.LibusbProxyDataModel.LibusbJsDevice;

/**
 * Implements the Libusb requests via the chrome.usb Apps API.
 */
GSC.LibusbToChromeUsbAdaptor = class extends GSC.LibusbToJsApiAdaptor {
  constructor() {
    super();
    /**
     * Mapping from IDs (generated by us) into device objects (returned by the
     * chrome.usb API).
     * @type {!Map<number, !chrome.usb.Device>}
     */
    this.idToChromeUsbDeviceMap_ = new Map();
  }

  /** @override */
  async listDevices() {
    const chromeUsbDevices = /** @type {!Array<!chrome.usb.Device>} */ (
        await promisify(chrome.usb.getDevices, /*options=*/ {}));

    // Keep references to all current chrome.usb.Device objects, since other API
    // functions take chrome.usb.Device as parameter, meanwhile the requests
    // from the C++ side only specify the deviceId. While we could try
    // recreating the chrome.usb.Device objects on the flight, based on the
    // LibusbJsDevice instances, it's error-prone and also breaks when a new
    // field gets added into chrome.usb.Device.
    this.updateDeviceMap_(chromeUsbDevices);

    return chromeUsbDevices.map(convertChromeUsbDeviceToLibusb);
  }

  /**
   * @private
   * @param {!Array<!chrome.usb.Device>} chromeUsbDevices
   */
  updateDeviceMap_(chromeUsbDevices) {
    this.idToChromeUsbDeviceMap_ = new Map();
    for (const chromeUsbDevice of chromeUsbDevices)
      this.idToChromeUsbDeviceMap_.set(chromeUsbDevice.device, chromeUsbDevice);
  }
};

/**
 * Returns whether the API needed for this adaptor to work is available.
 * @static
 * @return {boolean}
 */
GSC.LibusbToChromeUsbAdaptor.isApiAvailable = function() {
  return chrome !== undefined && chrome.usb !== undefined;
};

/**
 * Runs the specified chrome.usb API method and returns its result via a
 * promise.
 * @param {!Function} apiMethod The chrome.usb API method to call.
 * @param {...*} apiArguments The parameters to pass to the called method.
 * @return {!Promise<*>}
 */
function promisify(apiMethod, ...apiArguments) {
  return new Promise((resolve, reject) => {
    apiMethod.call(chrome.usb, ...apiArguments, function(apiResult) {
      if (chrome.runtime.lastError) {
        const apiError = goog.object.get(
            chrome.runtime.lastError, 'message', 'Unknown error');
        reject(apiError);
        return;
      }
      resolve(apiResult);
    });
  });
}

/**
 * @param {!chrome.usb.Device} chromeUsbDevice
 * @return {!LibusbJsDevice}
 */
function convertChromeUsbDeviceToLibusb(chromeUsbDevice) {
  /** @type {!LibusbJsDevice} */
  const libusbJsDevice = {
    'deviceId': chromeUsbDevice.device,
    'vendorId': chromeUsbDevice.vendorId,
    'productId': chromeUsbDevice.productId,
    'productName': chromeUsbDevice.productName,
    'manufacturerName': chromeUsbDevice.manufacturerName,
    'serialNumber': chromeUsbDevice.serialNumber,
  };
  if (typeof chromeUsbDevice.version !== undefined &&
      typeof chromeUsbDevice.version !== null) {
    // The "version" field was only added in Chrome 51.
    libusbJsDevice['version'] = chromeUsbDevice.version;
  }
  return libusbJsDevice;
}
});  // goog.scope
